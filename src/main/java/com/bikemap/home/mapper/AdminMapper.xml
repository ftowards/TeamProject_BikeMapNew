<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bikemap.home.admin.AdminDaoImp">
	<!-- admin추가 -->
	<select id="selectRegistAll" parameterType="com.bikemap.home.admin.AdminSearchVO" resultType="com.bikemap.home.admin.AdminRegistVO"><!-- VO하나만 합성으로 설정 -->
	 	select rownum, a.userid, a.username, a.gender, trunc((to_number(to_char(sysdate, 'YYYY'))-to_number(to_char(a.birth, 'YYYY'))+1),-1) birth, a.tourcnt, a.heart, (select to_char(s.endday,'YY-MM-DD')	
		from suspend s <![CDATA[ where s.userid = a.userid and rownum=1 and s.endday>=sysdate]]>) endday from regist a <include refid="search"></include> order by rownum desc
	</select>
	<!-- 페이지 검색시 사용 -->
	<sql id="search">
		<if test="searchType != null">					
			<if test="searchType == 'userAll'.toString()">WHERE USERID LIKE '%' || #{searchWord} || '%' OR  USERNAME LIKE '%' || #{searchWord} || '%'</if>
			<if test="searchType == 'userid'.toString()">WHERE USERID LIKE '%' || #{searchWord} || '%' </if>
			<if test="searchType == 'username'.toString()">WHERE USERNAME LIKE '%' || #{searchWord} || '%' </if>
		</if>
	</sql>
	<select id="searchTotalRecord" resultType="int">
		select count(userid) from regist 
	</select>
	
	<select id="searchRecord" parameterType="com.bikemap.home.admin.AdminSuspendVO" resultType="int">
		select count(userid) from regist <include refid="search"></include>
	</select>
	
	<!-- 정지 추가하기	 -->
	<insert id="suspendInsert" parameterType="com.bikemap.home.admin.AdminSuspendVO">
 		insert into suspend(userid, endday, cause)
		values(#{userid}, to_date(sysdate+#{endday}, 'YY-MM-DD'),#{cause})
	</insert>
	<!-- 
		SELECT ENDDAY FROM SUSPEND WHERE ROWNUM <=1 ORDER BY ENDDAY
		SELECT ENDDAY FROM SUSPEND WHERE USERID ='슈퍼맨' AND ROWNUM <=1 ORDER BY ENDDAY
	 -->
	<update id="suspendUpdate" parameterType="com.bikemap.home.admin.AdminSuspendVO">
		update suspend set endday=endday+#{endday}, cause=#{cause} 
		where rownum=1 and userid=#{userid} and endday>=sysdate
	</update>
	<select id = "getStopState" resultType="int"><!-- VO하나만 합성으로 설정 -->
	 	select count(userid) from suspend where rownum=1 and userid=#{userid} and endday>=sysdate
	</select>
	<select id = "getEndday" parameterType="com.bikemap.home.admin.AdminSuspendVO" resultType="com.bikemap.home.admin.AdminSuspendVO"><!-- VO하나만 합성으로 설정 -->
	 	select to_char(endday,'YY-MM-DD') enddayStr, userid from suspend where rownum=1 and userid=#{userid} and endday>=sysdate
	</select>

</mapper> 