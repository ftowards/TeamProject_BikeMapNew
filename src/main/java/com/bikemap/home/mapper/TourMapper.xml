<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.bikemap.home.tour.TourDaoImp">
 	<select id="selectAllTour" resultType="com.bikemap.home.tour.TourVO" parameterType="com.bikemap.home.tour.PagingVO">
		select * from 
			(select * from 
				(select noboard, title, to_char(departure,'YY/MM/DD') departure, to_char(arrive,'YY/MM/DD') arrive, reference from tour
				where state = '1'	order by noboard desc)
 			where rownum <![CDATA[<= ]]> (#{nowPage} * #{onePageRecord}) order by noboard asc)
		where rownum <![CDATA[<= ]]> #{lastPageRecordCount} order by noboard desc 
	</select>
	<select id="selectTour" resultType="com.bikemap.home.tour.TourVO" parameterType="com.bikemap.home.tour.PagingVO">
		select * from 
			(select * from 
				(select noboard, title, to_char(departure,'YY/MM/DD') departure, to_char(arrive,'YY/MM/DD') arrive, reference from tour
					where state = '1'
					<if test='regage != null and regage neq ""'>
			 			and regage like '%'||#{regage}||'%' and reggender like '%'||#{reggender}||'%' 
				 	</if>
				 	<if test='departuredate neq null and !"".equals(departuredate)'>
				 		and departure <![CDATA[>= ]]> to_date(#{departure}, 'YYYY/MM/DD HH24') 
				 	</if>
				 	<if test='arrivedate neq null and !"".equals(arrivedate)'>
				 		and arrive <![CDATA[<= ]]> to_date(#{arrive}, 'YYYY/MM/DD HH24') 
				 	</if>	 		 	
				 	<if test='place neq null and place neq ""'>
				 		and place like '%'||#{place}||'%'
				 	</if>
				 	<if test="distance1 gt 0">
				 		and distance <![CDATA[>= ]]> ${distance1}
				 	</if>
				 	<if test="distance2 gt 0">
				 		and distance <![CDATA[<= ]]> ${distance2}
				 	</if>
				order by noboard desc)
 			where rownum <![CDATA[<= ]]> (#{nowPage} * #{onePageRecord}) order by noboard asc)
		where rownum <![CDATA[<= ]]> #{lastPageRecordCount} order by noboard desc 
	</select>
	<select id="getTotalTourRecord" resultType="int" parameterType="com.bikemap.home.tour.PagingVO">
	 	select count(noboard) from tour where state = '1'
	</select>
	<select id="getTourRecord" resultType="int" parameterType="com.bikemap.home.tour.PagingVO">
		select count(noboard) from tour
	 		where state = '1'
		 	<if test='regage != null and regage neq ""'>
		 		and regage like '%'||#{regage}||'%' and reggender like '%'||#{reggender}||'%' 
		 	</if>
		 	<if test='departuredate neq null and !"".equals(departuredate)'>
		 		and departure <![CDATA[>= ]]> to_date(#{departure}, 'YYYY/MM/DD HH24') 
		 	</if>
		 	<if test='arrivedate neq null and !"".equals(arrivedate)'>
		 		and arrive <![CDATA[<= ]]> to_date(#{arrive}, 'YYYY/MM/DD HH24') 
		 	</if>	 		 	
		 	<if test='place neq null and place neq ""'>
		 		and place like '%'||#{place}||'%'
		 	</if>
		 	<if test="distance1 gt 0">
		 		and distance <![CDATA[>= ]]> #{distance1}
		 	</if>
		 	<if test="distance2 gt 0">
		 		and distance <![CDATA[<= ]]> #{distance2}
		 	</if>		 	
	</select>
	<insert id="tourInsert" parameterType="com.bikemap.home.tour.TourVO">
		insert into tour(noboard, title, userid, reference, content, deadline, departure, arrive, place, distance, speed, budget, room, reggender, regage, ip)
		values(a_sq.nextval, #{title}, #{userid}, #{reference}, #{content}, to_date(#{deadline}, 'YYYY/MM/DD HH24'), to_date(#{departure}, 'YYYY/MM/DD HH24'), to_date(#{arrive}, 'YYYY/MM/DD HH24'), #{place}, 
		#{distance}, #{speed, jdbcType=VARCHAR}, #{budget, jdbcType=VARCHAR}, #{room}, #{reggender}, #{regage}, #{ip})
	</insert>
	<select id="tourSelect" parameterType="int" resultType="com.bikemap.home.tour.TourVO">
		select noboard, title, userid, reference, content, to_char(deadline,'YY/MM/DD HH24') deadline,to_char(departure,'YY/MM/DD HH24') departure,
		to_char(arrive,'YY/MM/DD HH24') arrive,	place, distance, speed, budget, room, reggender, regage 
	 	from tour where noboard = #{noboard}
	</select>
 	<select id="lastTourNo" resultType="int">
		select noboard from (select noboard from tour where userid = #{param1} order by 1 desc) where rownum = 1
	</select>
	<insert id="insertTourComplist" parameterType="com.bikemap.home.tour.ComplistVO">
		insert into complist(noboard, userid, state) values(#{noboard}, #{userid}, #{state})
	</insert>
	<select id="checkTourComplist" resultType="String" parameterType="com.bikemap.home.tour.ComplistVO">
		select state from complist where noboard =#{noboard} and userid = #{userid}
	</select>
	<delete id="cancelTour" parameterType="com.bikemap.home.tour.ComplistVO">
		delete from complist where noboard = #{noboard} and userid = #{userid}
	</delete>
	<select id="selectTourComplist" resultType="com.bikemap.home.tour.ComplistVO">
		select a.userid, trunc((to_number(to_char(sysdate, 'YYYY'))-to_number(to_char(b.birth, 'YYYY'))+1),-1) age,
		b.gender, b.tourcnt, b.heart, a.state from complist a join regist b on a.userid = b.userid where a.noboard = #{param1}
		order by a.state desc, userid asc
	</select>
	<select id="getDeadline" resultType="String">
		select to_char(deadline, 'YYYY/MM/DD/HH24') deadline from tour where noboard =#{param1}
	</select>
 </mapper>